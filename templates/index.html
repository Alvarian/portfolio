{% extends 'layout.html' %}

{% block body %}
<nav style="padding: 10px 0; font-size: 12pt; background-color: black; color: white;" class="row spaced pressStart">
	<div class="menu lrg">
		<div class="menuLayer">
			<div>Ivan Alvarez</div>
			<div class="naver">
				<div><a class="bleach med" href="/">/about</a></div>
				<!-- <div><a class="bleach" href="/hobbies">/hobbies</a></div> -->
				<div><a class="bleach" href="/contact">/contact</a></div>
			{% if session.logged_in %}
				<div><a class="bleach" href="/portal">/portal</a></div>

				<div><a class="bleach" href="/logout">/logout</a></div>
			{% endif %}
			</div>
			<div class="drop"></div>
		</div>
	</div>
</nav>

<div id="app">
	<h1 class="orb codepro" style="text-align: center;">Project Gallery</h1>
	<div class="row">
		
		<div class="synop">
			<h2 class="orb codepro">Synopsis</h2>
			<div style="height: 70%; font-size: 7pt;; margin: 0;" class="pressStart betweened">
				<div style="width: 100%">
					<h3 class="title" style="text-decoration: underline; width: 100%;">Hover Over an App! >></h3>
					<p class="article description">Hover over an app! >></p>
				</div>
				<div class="type">Hover over an app! >></div>	
				<div class="icons"></div>		
			</div>
		</div>

		<div class="cards">
			<div class="gallery gall">
			{% for i in range(0, len) %}
				<div style="display: none;" class="open_{{ files[i].id }}" id="modal">
					<!-- FOR GAMES -->
					{% if files[i].app %}
						{% if files[i].app == 'None' %}
						{% else %}
							<div class="modal-content">
								<a href="#" class="close {{ files[i].id }}_close">X</a>
								<div class="border">
									<div style="width: 100%; height: 100%" class="{{ files[i].title }}_model"></div>
								</div>
							</div>

							<!-- <script>
								// When the user clicks on the button, open the modal 
								$(document).ready(() => {
									$.ajax({
										url: "{{ files[i].app }}",
										type: "GET",
										crossDomain: true, 
										success: function(encryptedScript) {
											if ("{{ is_cached }}" === "no") {
												let payload = "{{ files[i] }}";
												payload.app = encryptedScript;
												
												$.ajax({
													url: "/projects/cache", 
													type: "POST", 
													data: JSON.stringify(payload),
													success: function(result){
														console.log("cached");
													}
												});
											}
											// decryptAndEvaluateCode(encryptedScript, {{ files[i].securitykey }})
											eval(encryptedScript)

											const setCacheResponse = await fetch("/projects/set-cache", {
												method: 'POST',
												headers: {
													'Accept': 'application/json',
													'Content-Type': 'application/json'
												},
												body: JSON.stringify({
													data: zippedS3ResponseData,
													title: "{{ files[i].title }}"
												})
											});
											if (!setCacheResponse.ok) throw setCacheResponse;

											unZipDecryptAndEvaluate(zippedS3ResponseData, "{{ files[i].secret }}");
										} else {
											console.log("process data", getResponseData.length)
											unZipDecryptAndEvaluate(getResponseData, "{{ files[i].secret }}");
										}
									} catch (err) {
										console.log(err)
									}
								}



									// fetch("{{ files[i].game_file }}")
									// 	.then(res => {
									// 		if (!isCached) {
									// 			return res.text();
									// 		}

									// 		return res.json();
									// 	})
									// 	.then(zippedOrCachedData => {
									// 		const payloadToCache = JSON.parse(`{{ files[i]|tojson|safe }}`);
									// 		payloadToCache.game_file = zippedOrCachedData;
									// 		const formatted = JSON.stringify(payloadToCache);
									// 		// console.log(formatted);

									// 		if (!isCached) {
									// 			fetch("/projects/cache", {
									// 				method: "POST",
									// 				headers: {
									// 					'Accept': 'application/json',
									// 					'Content-Type': 'application/json'
									// 				},
									// 				body: formatted
									// 			})
									// 			.then(res => res)
									// 			.then(newCachedData => {
									// 				console.log("decrypt cached payload", newCachedData)
									// 				// decryptAndEvaluateCode(newCachedData, "{{ files[i].secret }}")
												
									// 				// Window.games["{{i}}"](document.querySelector(`.{{ files[i].title }}_model`));
									// 			})
									// 			.catch(error => console.log(error));
									// 		} else {
									// 			console.log("decrypt cached payload", zippedOrCachedData)
									// 			// decryptAndEvaluateCode(newCachedData, "{{ files[i].secret }}")

									// 			// Window.games["{{i}}"](document.querySelector(`.{{ files[i].title }}_model`));
									// 		}
									// 	})
									// 	.catch(error => console.log(error));
							</script> -->
						{% endif %}

					<!-- FOR DEPLOYED -->
					{% if files[i].website %}
						{% if files[i].website == 'None' %}
						{% else %}
							<div class="modal-content">
								<a href="#" class="close {{ files[i].id }}_close">X</a>
								<div class="border">
									<iframe frameborder="0" src="{{ files[i].website }}" height="100%" width="100%"></iframe>
								</div>
							</div>
						{% endif %}
					{% endif %}
				</div>

				<div class="dropCard">
					<div style="position: relative;">
						<div style="background-image: url('{{ files[i].icon }}');" class="card card_{{ files[i].id }}"></div>
						<div class="article lay lay_{{ files[i].id }}">
							<h2 class="clickOpen orbi card_{{ files[i].id }}">OPEN</h2>
						</div>
					</div>
					<div style="height: 100px;"></div>
					<!-- GITHUB button -->
					<a class="gitBTN" target="_blank" href={{ files[i].repository }}><i class="fab fa-4x fa-github"></i></a>
				</div>

				<script>
					$(window).ready(() => {
						let clickWin = (e) => {
							let element = e.target.className;
							if(element == 'article lay lay_{{ files[i].id }}' || element == 'clickOpen orbi card_{{ files[i].id }}' || element == 'card card_{{ files[i].id }}'){
								$(".card_{{ files[i].id }}").css('transform', 'scale(1.2)');
								$(".lay_{{ files[i].id }}").css('display','flex');
								$(".description").text('{{ files[i].description }}');
								$(".title").text('{{ files[i].title }}');
								$(".type").text('{{ files[i].projectType }}');
								// console.log('over');
							} else {
								$(".card_{{ files[i].id }}").css('transform', 'scale(1)');
								$(".lay_{{ files[i].id }}").css('transform', 'scale(1)');
								$(".lay_{{ files[i].id }}").css('display', 'none');
								// console.log('out', element);
							}
						}
						if(window.innerWidth <= 600){
							$('.card_{{ files[i].id }}').on('click', (e) => {
								$(".card_{{ files[i].id }}").css('transform', 'scale(1.2)');
								$(".lay_{{ files[i].id }}").css('display','flex');
								$(".description").text('{{ files[i].description }}');
								$(".title").text('{{ files[i].title }}');
								$(".type").text('{{ files[i].projectType }}');
								console.log('lay');
							});
							$(window).on('click', (e) => {
								clickWin(e);
							});
							$(window).on('click', (e) => {
								let element = e.target.className;
								if(element == 'article lay lay_{{ files[i].id }}' || element == 'clickOpen orbi card_{{ files[i].id }}'){

									$(".open_{{ files[i].id }}").css('display','block');
								}
							});
						} else {
							$(window).on('click', (e) => {
								let element = e.target.className;
								if(element == 'article lay lay_{{ files[i].id }}' || element == 'clickOpen orbi card_{{ files[i].id }}'){
									if (handleGameCoreFetch) {
										handleGameCoreFetch();
									}
									$(".open_{{ files[i].id }}").css('display','block');
								}
							});
							$(window).on('mouseover', (e) => {
								clickWin(e);
							});
						}
					})	

					// When the user clicks on <span> (x), close the modal
					document.getElementsByClassName("{{ files[i].id }}_close")[0].onclick = () => {
						$(".open_{{ files[i].id }}").css('display','none');
					}
				</script>
			{% endfor %}		
			</div>
		</div>
	</div>
</div>
{% endblock %}